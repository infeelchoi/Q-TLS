#
# Apache APISIX Q-TLS 라우트 설정
#
# 이 설정은 Apache APISIX API Gateway에서 Q-TLS를 사용하여
# 양자 내성 암호화를 적용하는 방법을 보여줍니다.
#
# APISIX Q-TLS 플러그인은 업스트림 서비스와의 통신에
# Q-TLS를 사용하여 양자 컴퓨터 공격으로부터 보호합니다.
#

# ============================================================
# 업스트림 서비스 정의
# ============================================================
upstreams:
  # Q-TLS를 사용하는 백엔드 서비스
  - id: qtls-backend
    name: "QSIGN Q-TLS Backend Service"
    desc: "양자 내성 암호화를 사용하는 백엔드 서비스"

    # 업스트림 노드 (Q-TLS 서버들)
    nodes:
      - host: "10.0.1.10"
        port: 8443
        weight: 1
      - host: "10.0.1.11"
        port: 8443
        weight: 1
      - host: "10.0.1.12"
        port: 8443
        weight: 1

    # 로드 밸런싱 방식
    type: roundrobin  # roundrobin, chash, ewma, least_conn

    # 헬스 체크 설정
    checks:
      active:
        type: https
        http_path: /health
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 5
          http_failures: 3

    # Q-TLS 설정
    scheme: qtls  # 'qtls' 스킴 사용

    # 타임아웃 설정
    timeout:
      connect: 10
      send: 10
      read: 10

    # 재시도 설정
    retries: 2
    retry_timeout: 5

# ============================================================
# SSL 인증서 설정 (클라이언트 facing)
# ============================================================
ssls:
  # APISIX 게이트웨이의 SSL/TLS 인증서
  - id: gateway-ssl
    cert: |
      -----BEGIN CERTIFICATE-----
      # APISIX 게이트웨이 인증서 (클라이언트 연결용)
      # 일반적인 TLS 1.3 인증서 사용
      -----END CERTIFICATE-----
    key: |
      -----BEGIN PRIVATE KEY-----
      # APISIX 게이트웨이 개인키
      -----END PRIVATE KEY-----
    snis:
      - "api.qsign.local"
      - "*.api.qsign.local"

# ============================================================
# Q-TLS 클라이언트 인증서 (업스트림 연결용)
# ============================================================
qtls_client_certificates:
  - id: qtls-client-cert
    name: "APISIX Q-TLS Client Certificate"

    # APISIX가 Q-TLS 서버에 연결할 때 사용하는 클라이언트 인증서
    certificate: |
      -----BEGIN CERTIFICATE-----
      # QSIGN PKI에서 발급한 클라이언트 인증서
      # Q-TLS 상호 인증에 사용
      -----END CERTIFICATE-----

    private_key: |
      -----BEGIN PRIVATE KEY-----
      # 클라이언트 개인키
      # 프로덕션: HSM에 저장 권장
      -----END PRIVATE KEY-----

    # 또는 HSM 사용
    # hsm_config:
    #   module: "/usr/lib/libCryptoki2_64.so"
    #   token: "apisix-token"
    #   key_label: "apisix-client-key"

    # CA 인증서 (서버 인증서 검증용)
    ca_certificate: |
      -----BEGIN CERTIFICATE-----
      # QSIGN Root CA 인증서
      -----END CERTIFICATE-----

# ============================================================
# 라우트 정의
# ============================================================
routes:
  # Q-TLS를 사용하는 API 라우트
  - id: qtls-secure-api
    name: "Q-TLS Secure API Route"
    desc: "양자 내성 암호화를 사용하는 보안 API 엔드포인트"

    # URI 매칭
    uri: "/api/v1/*"

    # 호스트 매칭
    host: "api.qsign.local"

    # HTTP 메소드
    methods:
      - GET
      - POST
      - PUT
      - DELETE

    # 업스트림 참조
    upstream_id: qtls-backend

    # 플러그인 설정
    plugins:
      # Q-TLS 플러그인 활성화
      qtls:
        # Q-TLS 프로토콜 버전
        protocol_version: "1.3"

        # 하이브리드 PQC 모드
        pqc_mode: "hybrid"  # hybrid, pqc-only, classical-only

        # 지원하는 PQC 알고리즘
        pqc_kems:
          - "kyber1024"
          - "kyber768"

        pqc_signatures:
          - "dilithium3"
          - "dilithium2"

        # 클라이언트 인증서 (상호 TLS)
        client_certificate_id: qtls-client-cert

        # 서버 인증서 검증
        verify_server: true
        verify_depth: 3

        # 세션 재개 활성화
        session_reuse: true
        session_timeout: 3600

        # 연결 풀링
        keepalive: true
        keepalive_timeout: 60
        keepalive_pool: 10

      # 속도 제한
      limit-req:
        rate: 100
        burst: 200
        key: "remote_addr"
        rejected_code: 429

      # API 키 인증
      key-auth:
        key: "apikey"

      # 요청/응답 로깅
      http-logger:
        uri: "http://logger.qsign.local/logs"
        include_req_body: true
        include_resp_body: false

      # CORS
      cors:
        allow_origins: "https://app.qsign.local"
        allow_methods: "GET,POST,PUT,DELETE"
        allow_headers: "Authorization,Content-Type"
        max_age: 3600

      # 응답 캐싱
      proxy-cache:
        cache_ttl: 300
        cache_bypass:
          - "$arg_bypass"
        cache_key:
          - "$host"
          - "$request_uri"

  # 관리 API 라우트 (높은 보안)
  - id: qtls-admin-api
    name: "Q-TLS Admin API Route"
    uri: "/admin/*"
    host: "admin.qsign.local"

    upstream_id: qtls-backend

    plugins:
      qtls:
        pqc_mode: "hybrid"
        pqc_kems: ["kyber1024"]
        pqc_signatures: ["dilithium3"]
        client_certificate_id: qtls-client-cert
        verify_server: true

        # 강화된 보안 설정
        min_protocol_version: "1.3"
        cipher_suites:
          - "TLS_AES_256_GCM_SHA384_KYBER1024_DILITHIUM3"

      # IP 화이트리스트
      ip-restriction:
        whitelist:
          - "10.0.0.0/8"
          - "172.16.0.0/12"

      # 관리자 인증
      openid-connect:
        discovery: "https://auth.qsign.local/.well-known/openid-configuration"
        client_id: "apisix-admin"
        client_secret: "${OIDC_CLIENT_SECRET}"
        scope: "openid profile email"

  # 헬스 체크 라우트 (Q-TLS 없음)
  - id: health-check
    name: "Health Check Route"
    uri: "/health"

    plugins:
      # 간단한 응답 반환
      response-rewrite:
        status_code: 200
        body: '{"status":"healthy"}'
        headers:
          Content-Type: "application/json"

# ============================================================
# 글로벌 규칙
# ============================================================
global_rules:
  # Q-TLS 성능 모니터링
  - id: qtls-monitoring
    plugins:
      prometheus:
        prefer_name: true

      # 분산 추적
      zipkin:
        endpoint: "http://zipkin.qsign.local:9411/api/v2/spans"
        sample_ratio: 0.1

      # 에러 로깅
      error-log-logger:
        uri: "http://logger.qsign.local/errors"

# ============================================================
# 서비스 정의
# ============================================================
services:
  - id: qtls-service
    name: "QSIGN Q-TLS Service"
    upstream_id: qtls-backend

    # 서비스 레벨 플러그인
    plugins:
      qtls:
        pqc_mode: "hybrid"
        client_certificate_id: qtls-client-cert

      # 서킷 브레이커
      api-breaker:
        break_response_code: 503
        max_breaker_sec: 300
        unhealthy:
          http_statuses: [500, 502, 503]
          failures: 3
        healthy:
          http_statuses: [200]
          successes: 2

# ============================================================
# 소비자 정의 (API 키 인증)
# ============================================================
consumers:
  - username: "client-app-1"
    desc: "클라이언트 애플리케이션 1"
    plugins:
      key-auth:
        key: "qsign-app-1-key-xxxxx"

      # 소비자별 속도 제한
      limit-req:
        rate: 500
        burst: 1000

  - username: "client-app-2"
    desc: "클라이언트 애플리케이션 2"
    plugins:
      key-auth:
        key: "qsign-app-2-key-yyyyy"

# ============================================================
# 플러그인 메타데이터
# ============================================================
plugin_metadata:
  # Q-TLS 플러그인 글로벌 설정
  - id: qtls
    log_level: "info"

    # 성능 튜닝
    performance:
      connection_pool_size: 100
      max_idle_timeout: 300

    # 보안 설정
    security:
      # 약한 암호 스위트 비활성화
      disable_weak_ciphers: true

      # 재협상 방지
      disable_renegotiation: true

      # OCSP Stapling
      ocsp_stapling: true

    # 모니터링
    monitoring:
      collect_metrics: true
      metrics_interval: 60

# ============================================================
# 사용 예시 및 테스트
# ============================================================
#
# 1. APISIX 설정 로드:
#    curl -X PUT http://127.0.0.1:9180/apisix/admin/routes/qtls-secure-api \
#      -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' \
#      -d @apisix_config.yaml
#
# 2. Q-TLS 라우트 테스트:
#    curl -k https://api.qsign.local/api/v1/users \
#      -H "apikey: qsign-app-1-key-xxxxx"
#
# 3. 메트릭 확인:
#    curl http://127.0.0.1:9091/apisix/prometheus/metrics | grep qtls
#
# 4. 성능 측정:
#    ab -n 1000 -c 10 \
#      -H "apikey: qsign-app-1-key-xxxxx" \
#      https://api.qsign.local/api/v1/test
#
# ============================================================

#
# 프로덕션 배포 체크리스트:
#
# □ QSIGN PKI에서 발급한 인증서 사용
# □ HSM에 개인키 저장
# □ Vault에서 인증서 동적 관리
# □ 모니터링 및 알림 설정
# □ 로그 중앙 집중화
# □ 백업 및 재해 복구 계획
# □ 성능 테스트 및 튜닝
# □ 보안 감사 및 침투 테스트
#
