# Apache APISIX Q-TLS Configuration Example
# Copyright 2025 QSIGN Project
#
# This configuration demonstrates Q-TLS integration with APISIX Gateway
# for quantum-resistant API gateway protection.

# APISIX Configuration
apisix:
  node_listen: 9080
  ssl:
    enable: true
    listen:
      - port: 9443
        enable_http2: true

  # Enable Q-TLS plugin
  plugins:
    - qtls

  # Plugin attributes
  plugin_attr:
    qtls:
      # Default HSM configuration
      hsm_pkcs11_lib: /usr/lib/libCryptoki2_64.so

      # Global Q-TLS settings
      hybrid_mode: true
      fips_mode: true

      # Performance tuning
      max_handshakes_per_sec: 1000
      session_cache_size: 5000

      # Logging
      log_level: info
      enable_metrics: true

# Upstream Services
upstreams:
  # Quantum-resistant API backend
  - id: qtls-backend
    name: "Q-TLS Protected Backend"
    type: roundrobin
    nodes:
      "backend1.example.com:8443": 1
      "backend2.example.com:8443": 1
    scheme: https

    # Upstream Q-TLS configuration
    tls:
      client_cert: /etc/apisix/ssl/client-cert.pem
      client_key: /etc/apisix/ssl/client-key.pem

    # Health checks
    checks:
      active:
        type: https
        https_verify_certificate: true
        healthy:
          interval: 10
          successes: 2
        unhealthy:
          interval: 10
          http_failures: 3

# SSL Certificates
ssl:
  # Q-TLS hybrid certificate (RSA + DILITHIUM3)
  - id: qtls-server-cert
    sni:
      - "api.example.com"
      - "*.api.example.com"
    cert: |
      -----BEGIN CERTIFICATE-----
      # Hybrid certificate containing both RSA and DILITHIUM3 keys
      # Generated by QSIGN CA
      MIIFxTCCBK2gAwIBAgIQabcdefghijklmnopqrstuvwxyzA...
      -----END CERTIFICATE-----
    key: "pkcs11:token=luna;object=qtls-server-key;type=private"

    # QSIGN CA chain
    certs:
      - |
        -----BEGIN CERTIFICATE-----
        # QSIGN Intermediate CA
        MIIFyDCCA7CgAwIBAgIQabcdefghijklmnopqrstuvwxyzB...
        -----END CERTIFICATE-----
      - |
        -----BEGIN CERTIFICATE-----
        # QSIGN Root CA
        MIIFzjCCA7agAwIBAgIQabcdefghijklmnopqrstuvwxyzC...
        -----END CERTIFICATE-----

# Routes with Q-TLS Protection
routes:
  # Public API with Q-TLS
  - id: public-api-qtls
    name: "Public API with Q-TLS"
    uri: /api/v1/*
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    upstream_id: qtls-backend

    plugins:
      qtls:
        certificate: /etc/apisix/ssl/qtls-server-cert.pem
        hsm_key_uri: "pkcs11:token=luna;object=qtls-server-key;type=private"
        hybrid_mode: true
        require_qtls: true

        # Allow only KYBER1024 and DILITHIUM3
        allowed_kems:
          - KYBER1024
        allowed_signatures:
          - DILITHIUM3

        # Session configuration
        session_timeout: 3600
        session_cache_size: 1000

        # QSIGN CA validation
        qsign_root_ca: /etc/apisix/ssl/qsign-root-ca.pem
        verify_depth: 3

        # Health check
        health_check:
          enabled: true
          interval: 60
          hsm_check: true

        # Metrics
        enable_metrics: true

      # Rate limiting
      limit-req:
        rate: 100
        burst: 200
        key: remote_addr

      # Response headers
      response-rewrite:
        headers:
          set:
            X-QTLS-Protected: "true"
            Strict-Transport-Security: "max-age=31536000; includeSubDomains"

  # Mutual TLS protected admin API
  - id: admin-api-mtls
    name: "Admin API with Mutual TLS"
    uri: /admin/*
    methods:
      - GET
      - POST
      - PUT
      - DELETE
    upstream_id: qtls-backend

    plugins:
      qtls:
        certificate: /etc/apisix/ssl/qtls-server-cert.pem
        hsm_key_uri: "pkcs11:token=luna;object=qtls-admin-key;type=private"
        hybrid_mode: true

        # Mutual TLS configuration
        mutual_tls: true
        client_ca_cert: /etc/apisix/ssl/qsign-ca-bundle.pem
        verify_depth: 3

        # Strict requirements
        require_qtls: true
        fallback_to_classical: false

        # FIPS mode for compliance
        fips_mode: true

      # IP whitelist
      ip-restriction:
        whitelist:
          - 10.0.0.0/8
          - 192.168.0.0/16

      # Authentication
      key-auth: {}

  # Health check endpoint (no Q-TLS required)
  - id: health-check
    name: "Health Check Endpoint"
    uri: /health
    methods:
      - GET

    plugins:
      serverless-pre-function:
        phase: rewrite
        functions:
          - return function(conf, ctx)
              ngx.say('{"status": "healthy", "qtls": "enabled"}')
              ngx.exit(200)
            end

# Global rules
global_rules:
  - id: qtls-global-protection
    plugins:
      qtls:
        # Default Q-TLS configuration for all routes
        hybrid_mode: true
        log_level: info
        enable_metrics: true

      # CORS
      cors:
        allow_origins: "*"
        allow_methods: "GET,POST,PUT,DELETE,OPTIONS"
        allow_headers: "DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization"
        max_age: 3600

# Plugin metadata
plugin_metadata:
  - id: qtls
    log_format:
      host: "$host"
      remote_addr: "$remote_addr"
      request_method: "$request_method"
      request_uri: "$request_uri"
      status: "$status"
      qtls_enabled: "$http_x_qtls_enabled"
      qtls_cipher: "$http_x_qtls_cipher"
      qtls_client_verified: "$http_x_qtls_client_verified"

# Service discovery (optional)
discovery:
  nacos:
    host:
      - "http://nacos.example.com:8848"
    prefix: /nacos/v1/
    fetch_interval: 30
    weight: 100

# Admin API configuration
deployment:
  role: traditional
  role_traditional:
    config_provider: etcd

  admin:
    admin_key:
      - name: "admin"
        key: "edd1c9f034335f136f87ad84b625c8f1"
        role: admin

    # Protect admin API with Q-TLS
    https_admin: true
    admin_listen:
      ip: 127.0.0.1
      port: 9180

# Etcd configuration
etcd:
  host:
    - "http://127.0.0.1:2379"
  prefix: /apisix
  timeout: 30

# Prometheus metrics
plugin_attr:
  prometheus:
    export_uri: /apisix/prometheus/metrics
    metric_prefix: apisix_
    enable_export_server: true
    export_addr:
      ip: 0.0.0.0
      port: 9091

# Example: Nginx configuration snippet for Q-TLS
nginx_config:
  http:
    # Load Q-TLS library
    lua_package_path: "/usr/local/apisix/?.lua;/usr/local/apisix/deps/share/lua/5.1/?.lua;;"
    lua_package_cpath: "/usr/local/lib/?.so;;"

    # Preload Q-TLS library
    init_by_lua_block: |
      require("apisix").http_init()

      -- Initialize Q-TLS
      local ffi = require("ffi")
      local qtls = ffi.load("/usr/local/lib/libqtls.so")

      -- Initialize HSM
      qtls.qtls_hsm_init("/usr/lib/libCryptoki2_64.so")

    # SSL session cache
    ssl_session_cache: shared:SSL:10m
    ssl_session_timeout: 1h

    # OCSP stapling
    ssl_stapling: on
    ssl_stapling_verify: on
    ssl_trusted_certificate: /etc/apisix/ssl/qsign-ca-bundle.pem
