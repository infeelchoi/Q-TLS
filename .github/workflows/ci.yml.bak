# Q-TLS GitHub Actions CI/CD 워크플로우
# 자동 빌드, 테스트, 보안 스캔, 성능 벤치마크
#
# Copyright 2025 QSIGN Project

name: Q-TLS CI/CD

# 트리거 조건
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # 매일 UTC 00:00에 실행 (nightly build)
    - cron: '0 0 * * *'

# 환경 변수
env:
  BUILD_TYPE: Release
  LIBOQS_VERSION: 0.10.1

jobs:
  # ============================================
  # Job 1: 빌드 및 단위 테스트
  # ============================================
  build-and-test:
    name: 빌드 및 단위 테스트
    runs-on: ubuntu-latest

    steps:
    # 1. 코드 체크아웃
    - name: 코드 체크아웃
      uses: actions/checkout@v3
      with:
        submodules: recursive

    # 2. 의존성 설치
    - name: 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libssl-dev \
          ninja-build \
          astyle \
          doxygen \
          valgrind

    # 3. liboqs 빌드 및 설치
    - name: liboqs 빌드
      run: |
        git clone --branch ${LIBOQS_VERSION} --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs
        mkdir build && cd build
        cmake -GNinja \
          -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DCMAKE_BUILD_TYPE=Release \
          -DOQS_USE_AVX2_INSTRUCTIONS=ON \
          ..
        ninja
        sudo ninja install
        sudo ldconfig

    # 4. Q-TLS 빌드
    - name: Q-TLS 빌드
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    # 5. 단위 테스트 실행
    - name: 단위 테스트 실행
      run: |
        cd tests/unit
        make clean
        make all
        ./run_tests.sh

    # 6. 테스트 결과 업로드
    - name: 테스트 결과 업로드
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: unit-test-results
        path: /tmp/test_*.log

  # ============================================
  # Job 2: 통합 테스트
  # ============================================
  integration-test:
    name: 통합 테스트
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: 의존성 및 liboqs 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libssl-dev
        git clone --branch ${LIBOQS_VERSION} --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs && mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Q-TLS 빌드
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ..
        make -j$(nproc)

    - name: 통합 테스트 실행
      run: |
        cd tests/integration
        make clean
        make all
        make test

  # ============================================
  # Job 3: 보안 테스트
  # ============================================
  security-test:
    name: 보안 테스트
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libssl-dev valgrind
        git clone --branch ${LIBOQS_VERSION} --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs && mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Q-TLS 빌드
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=${BUILD_TYPE} ..
        make -j$(nproc)

    - name: 타이밍 공격 테스트
      run: |
        cd tests/security
        gcc -Wall -O2 -I../../include -o test_timing test_timing.c \
          -L../../build -lqtls -loqs -lcrypto -lm
        LD_LIBRARY_PATH=../../build ./test_timing

    - name: 인증서 검증 테스트
      run: |
        cd tests/security
        gcc -Wall -O2 -I../../include -o test_certificate_validation \
          test_certificate_validation.c -L../../build -lqtls -loqs -lcrypto
        LD_LIBRARY_PATH=../../build ./test_certificate_validation

    - name: 퍼징 테스트
      run: |
        cd tests/security
        gcc -Wall -O2 -I../../include -o fuzz_handshake fuzz_handshake.c \
          -L../../build -lqtls -loqs -lcrypto
        LD_LIBRARY_PATH=../../build ./fuzz_handshake

    # Valgrind 메모리 누수 검사
    - name: 메모리 누수 검사
      run: |
        cd tests/unit
        make all
        for test in test_kyber test_dilithium test_handshake test_session; do
          echo "Valgrind 검사: $test"
          LD_LIBRARY_PATH=../../build valgrind \
            --leak-check=full \
            --error-exitcode=1 \
            --show-leak-kinds=all \
            ./$test || exit 1
        done

  # ============================================
  # Job 4: 성능 벤치마크
  # ============================================
  benchmark:
    name: 성능 벤치마크
    needs: build-and-test
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libssl-dev
        git clone --branch ${LIBOQS_VERSION} --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs && mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local \
          -DOQS_USE_AVX2_INSTRUCTIONS=ON ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: Q-TLS 빌드 (최적화)
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_C_FLAGS="-O3 -march=native" ..
        make -j$(nproc)

    - name: 벤치마크 실행
      run: |
        cd tools/benchmark
        make clean
        make all
        ./run_benchmark.sh

    - name: 벤치마크 결과 업로드
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: tools/benchmark/benchmark_results/

  # ============================================
  # Job 5: 코드 품질 검사
  # ============================================
  code-quality:
    name: 코드 품질 검사
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: 정적 분석 도구 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y cppcheck clang-tidy

    # cppcheck 정적 분석
    - name: cppcheck 분석
      run: |
        cppcheck --enable=all --error-exitcode=1 \
          --suppress=missingIncludeSystem \
          -I include src/ tests/

    # 코드 스타일 검사
    - name: 코드 스타일 검사
      run: |
        find src include tests -name "*.c" -o -name "*.h" | \
          xargs clang-format --dry-run --Werror

  # ============================================
  # Job 6: 문서 생성
  # ============================================
  documentation:
    name: 문서 생성
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: Doxygen 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y doxygen graphviz

    - name: API 문서 생성
      run: |
        doxygen Doxyfile || echo "Doxyfile 없음"

    - name: 문서 업로드
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v3
      with:
        name: api-documentation
        path: docs/html/

  # ============================================
  # Job 7: 릴리즈 빌드
  # ============================================
  release:
    name: 릴리즈 빌드
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [build-and-test, integration-test, security-test]
    runs-on: ubuntu-latest

    steps:
    - name: 코드 체크아웃
      uses: actions/checkout@v3

    - name: 의존성 설치
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake libssl-dev
        git clone --branch ${LIBOQS_VERSION} --depth 1 https://github.com/open-quantum-safe/liboqs.git
        cd liboqs && mkdir build && cd build
        cmake -DCMAKE_INSTALL_PREFIX=/usr/local ..
        make -j$(nproc)
        sudo make install
        sudo ldconfig

    - name: 릴리즈 빌드
      run: |
        mkdir build && cd build
        cmake -DCMAKE_BUILD_TYPE=Release ..
        make -j$(nproc)
        make package

    - name: 릴리즈 생성
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Q-TLS ${{ github.ref }}
        draft: false
        prerelease: false

# ============================================
# 알림 설정 (선택사항)
# ============================================
# Slack, Discord 등 알림 통합 가능
